---
// frontend/src/pages/analytics.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="Analytics - Knowledge System">
  <div class="px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">System Analytics</h1>
      <p class="text-gray-600">Monitor system usage, document trends, and knowledge graph insights</p>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="bg-blue-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="total-documents">-</div>
            <div class="text-sm text-gray-600">Total Documents</div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="bg-green-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="graph-nodes">-</div>
            <div class="text-sm text-gray-600">Knowledge Nodes</div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="bg-purple-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"></path>
            </svg>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="graph-relationships">-</div>
            <div class="text-sm text-gray-600">Relationships</div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="bg-orange-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="interactions-today">-</div>
            <div class="text-sm text-gray-600">Interactions Today</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Server Health -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üñ•Ô∏è Server Health</h3>
        <div id="server-health" class="space-y-3">
          <!-- Server status will be loaded here -->
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Recent Activity</h3>
        <div id="recent-activity" class="space-y-3">
          <!-- Recent activity will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Document Categories -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">üìÇ Document Categories</h3>
      <div id="categories-chart" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- Categories will be loaded here -->
      </div>
    </div>

    <!-- Knowledge Graph Insights -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">üï∏Ô∏è Knowledge Graph Insights</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium text-gray-700 mb-3">Top Node Types</h4>
          <div id="node-types" class="space-y-2">
            <!-- Node types will be loaded here -->
          </div>
        </div>
        <div>
          <h4 class="font-medium text-gray-700 mb-3">Top Relationship Types</h4>
          <div id="relationship-types" class="space-y-2">
            <!-- Relationship types will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Search Analytics -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">üîç Search Analytics</h3>
      <div id="search-analytics" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center">
          <div class="text-3xl font-bold text-blue-600" id="total-searches">-</div>
          <div class="text-sm text-gray-600">Total Searches (30 days)</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600" id="avg-results">-</div>
          <div class="text-sm text-gray-600">Avg Results per Search</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-purple-600" id="avg-response-time">-</div>
          <div class="text-sm text-gray-600">Avg Response Time (ms)</div>
        </div>
      </div>
      
      <div class="mt-6">
        <h4 class="font-medium text-gray-700 mb-3">Popular Search Terms</h4>
        <div id="popular-searches" class="flex flex-wrap gap-2">
          <!-- Popular searches will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-8">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
        <span class="text-gray-600">Loading analytics data...</span>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden bg-red-50 rounded-lg p-6">
      <div class="flex items-center">
        <div class="text-red-600 mr-3">‚ö†Ô∏è</div>
        <div>
          <h3 class="text-lg font-semibold text-red-900">Failed to Load Analytics</h3>
          <p id="error-message" class="text-red-800 mt-1"></p>
          <button onclick="loadAnalytics()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
            Retry
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const ORCHESTRATOR_URL = 'https://knowledge-base-orchestrator.azurewebsites.net';
  const SEARCH_SERVER_URL = 'https://web-search-mcp-server.azurewebsites.net';

  document.addEventListener('DOMContentLoaded', loadAnalytics);

  async function loadAnalytics() {
    showLoading();
    
    try {
      // Load system status
      await loadSystemStatus();
      
      // Load search analytics
      await loadSearchAnalytics();
      
      hideLoading();
    } catch (error) {
      console.error('Failed to load analytics:', error);
      showError(error.message);
    }
  }

  async function loadSystemStatus() {
    try {
      const response = await fetch(`${ORCHESTRATOR_URL}/api/status`);
      if (!response.ok) throw new Error('Failed to fetch system status');
      
      const data = await response.json();
      
      // Update key metrics
      if (data.status.database) {
        const db = data.status.database;
        updateElement('total-documents', db.total_documents || 0);
        updateElement('graph-nodes', db.total_graph_nodes || 0);
        updateElement('graph-relationships', db.total_graph_edges || 0);
        updateElement('interactions-today', db.interactions_today || 0);
      }
      
      // Update server health
      updateServerHealth(data.status.servers || {});
      
      // Update recent activity
      updateRecentActivity(data.status.recent_activity || []);
      
    } catch (error) {
      console.error('Failed to load system status:', error);
    }
  }

  async function loadSearchAnalytics() {
    try {
      const response = await fetch(`${SEARCH_SERVER_URL}/tools/search_analytics`);
      if (!response.ok) throw new Error('Failed to fetch search analytics');
      
      const data = await response.json();
      
      if (data.analytics) {
        const analytics = data.analytics;
        updateElement('total-searches', Math.round(analytics.total_searches || 0));      }
    } catch (error) {
      console.error('Failed to load search analytics:', error);
    }
  }
